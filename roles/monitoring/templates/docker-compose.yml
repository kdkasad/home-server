services:
  prometheus:
    container_name: prometheus
    image: quay.io/prometheus/prometheus:{{ monitoring_prometheus_tag }}
    pull_policy: always
    user: "{{ worker_uid }}"
    restart: unless-stopped
    volumes:
      - "{{ monitoring_prometheus_data_dir }}/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
      - "{{ monitoring_prometheus_data_dir }}/extra_scrape_configs.yml:/etc/prometheus/X_extra_scrape_configs.yml:ro"
      - "{{ monitoring_prometheus_data_dir }}/data:/prometheus"
    labels:
      traefik.enable: "{{ monitoring_prometheus_routing_enabled | ternary('true', 'false') }}"
      traefik.http.routers.prometheus.rule: Host(`{{ monitoring_prometheus_routing_subdomain }}.{{ general.domain }}`)
      traefik.http.routers.prometheus.middlewares: "{{ monitoring_prometheus_routing_private | ternary('privateip@file', '') }}"
      traefik.http.routers.prometheus.entrypoints: websecure
      traefik.http.services.prometheus.loadbalancer.server.port: "9090"

  grafana:
    container_name: grafana
    image: grafana/grafana-oss:{{ monitoring_grafana_tag }}
    pull_policy: always
    restart: unless-stopped
    user: "{{ worker_uid }}"
    volumes:
      - "{{ monitoring_grafana_data_dir }}/grafana.ini:/etc/grafana/grafana.ini"
      - "{{ monitoring_grafana_data_dir }}/data:/var/lib/grafana"
    environment:
      GF_RENDERING_SERVER_URL: http://renderer:8081/render
      GF_RENDERING_CALLBACK_URL: http://grafana:3000/
    labels:
      traefik.enable: "{{ monitoring_grafana_routing_enabled | ternary('true', 'false')}}"
      traefik.http.routers.grafana.rule: Host(`{{ monitoring_grafana_routing_subdomain }}.{{ general.domain }}`)
      traefik.http.routers.grafana.middlewares: "{{ monitoring_grafana_routing_private | ternary('privateip@file', '') }}"
      traefik.http.routers.grafana.entrypoints: websecure
      traefik.http.services.grafana.loadbalancer.server.port: "3000"

  renderer:
    container_name: grafana-renderer
    image: grafana/grafana-image-renderer:{{ monitoring_grafana_image_renderer_tag }}
    pull_policy: always
    restart: unless-stopped
    user: "{{ worker_uid }}"

  cadvisor:
    container_name: prometheus-cadvisor
    image: gcr.io/cadvisor/cadvisor:{{ monitoring_cadvisor_tag }}
    pull_policy: always
    restart: unless-stopped
    # privileged: true
    devices:
      - /dev/kmsg
    volumes:
      - "/:/rootfs:ro"
      - "/var/run:/var/run:ro"
      - "/sys:/sys:ro"
      - "/var/lib/docker:/var/lib/docker:ro"
      - "/dev/disk:/dev/disk:ro"

  loki:
    container_name: loki
    image: grafana/loki:{{ monitoring_loki_tag }}
    pull_policy: always
    restart: unless-stopped
    user: "{{ worker_uid }}"
    command:
      - -config.file=/etc/loki/local-config.yaml
    ports:
      - '127.0.0.1:3100:80'
    expose:
      - 80
      - 9096
    volumes:
      - "{{ monitoring_loki_data_dir }}/local-config.yaml:/etc/loki/local-config.yaml"
      - "{{ monitoring_loki_data_dir }}/data:/loki"

  promtail:
    container_name: promtail
    image: grafana/promtail:{{ monitoring_promtail_tag }}
    pull_policy: always
    restart: unless-stopped
    user: "{{ worker_uid }}"
    group_add:
      - "{{ sd_journal_gid}}"  # Required for systemd-journal scraper
    command:
      - -config.file=/etc/promtail/config.yml
    expose:
      - 80
    volumes:
      - "{{ monitoring_promtail_data_dir }}/config.yml:/etc/promtail/config.yml"
      - "/var/log:/var/log:ro,rslave"
      - "/run/log/journal:/run/log/journal:ro,rslave"  # Required for systemd-journal scraper
      - "/etc/machine-id:/etc/machine-id:ro"  # Required for systemd-journal scraper
